//
// The log generated by adengine
// 

option optimize_for = SPEED;

package rubicon.data.ad_engine;

import "types.proto";
import "num_types.proto";
import "ip.proto";
import "geo.proto";
import "ae_types.proto";
import "ae_inventory.proto";
import "ae_publisher_user.proto";
import "adsafe.proto";

//
// data centers
//
message DataCenter_PB {
    enum DataCenterCodes_E {
        UNKNOWN     = 0;
        IAD1        = 1;
        LAX1        = 3;
        AMS2        = 4;
        QA			= 20;
    }     
    optional DataCenterCodes_E      name        = 1;
    optional string                 raw_value   = 2;    // in case colo is unknown
}

//
// DK History 
//
message DKHistory_PB {
    optional rubicon.data.common.AnUInt32_PB        ad_id       = 1;       //
    repeated uint32                                 zone_ids    = 2;
}

//
// impression type
//
message ImpressionType_PB {
    enum ImpressionCode_E {
        UNKNOWN_IMPRESSION  = 0;
        AD_IMPRESSION       = 1;           // ad impression
        START_SESSION       = 2;           // first ad impression of the user session
        CLICK               = 3;           // click
    }
    required ImpressionCode_E       code        = 2;      // Numerical representation of the impression
    optional string                 raw_value   = 3;      // Raw value (if unknown)
}

//
// market pricing
//
message MarketPricing_PB {
    optional string                 price_points_debug      = 1;       
}

//
// ad counters
//
message AdCounts_PB {
    optional uint32                 guaranteed_count        = 1;
    optional uint32                 bids_count              = 2;
    optional uint32                 bidded_ads_count        = 3;
    optional uint32                 total_valid_count       = 4;
}

//
// user specific info the AE log 
//
message UserInfo_PB {
    optional rubicon.data.common.IPAddress_PB       sender_addr             = 1;                // #2  | IP Address 
    optional string                                 user_id                 = 2;                // #21 | User ID string
    optional uint64                                 session_id              = 3;                // #22 | Session ID
    optional uint32                                 browser_time_stamp      = 4;                // #23/#24 | Hour/Date of User's Browser's Time
    optional uint32                                 browser_code            = 5;                // #14 | Browser ID Code
    optional uint32                                 os_code                 = 6;                // #15 | Operating System Code
    optional string                                 accept_language         = 7;                // #16 | Language
    optional string                                 user_agent_id           = 8;                // #41 | User-Agent identifier
    optional string                                 behavioral_cookie       = 9;                // #43 | Behavioral Cookie Data (rpb)
    optional uint64                                 site_size_count         = 10 [default = 0]; // #57 | Site+Size Session Count
}

//
// Geo specific info in the AE log
//
message GeoInfo_PB {
    optional rubicon.data.geo.Geo_PB                geo                     = 1;                // #4  | ISP Full Name
                                                                                                // #5  | ISP Speed
                                                                                                // #6  | Continent
                                                                                                // #7  | Country
                                                                                                // #8  | Region
                                                                                                // #9  | DMA Code
                                                                                                // #10 | City Name
                                                                                                // #11 | Zip Code
                                                                                                // #12 | Area Code
                                                                                                // #13 | GMT Offset
                                                                                                // #17 | ISP Domain name
}

//
// inventory specific info in the AE log
//
message InventoryInfo_PB {
    optional ImpressionType_PB                      impression_type         = 1;                // #3 | Impression Type
    optional string                                 refering_domain         = 2;                // #19 | Referring Domain
    optional string                                 refering_uri            = 3;                // #20 | Referring URI
    optional rubicon.data.common.MimeType_E         mime                    = 4 [default = UNKNOWN_MIME];     // #37 | Ad Type
    optional Inventory_PB                           inventory               = 5;                // #25 | Account ID
                                                                                                // #26 | Site ID
                                                                                                // #38 | Zone ID
                                                                                                // #39 | Size ID
                                                                                                // #27 | Zone Size ID (if not in "zone-size" format)
    optional PublisherUser_PB                       publisher_user          = 6;                // #28 | Keyword Data                                                                                   
                                                                                                // #29 | Gender
                                                                                                // #30 | Age
                                                                                                // #31 | Income
                                                                                                // #32 | Children
                                                                                                // #33 | HSize
                                                                                                // #34 | Ethnicity
                                                                                                // #35 | Education Level
}

//
// system specific info in the AE log
//
message SystemInfo_PB {
    enum FeatureCode_E {
        LOCAL_STORAGE = 1;
    }

    required uint32                         time_stamp              = 1;                // #1  | time stamp in sec
    optional uint64                         ae_response_time        = 2 [default = 0];  // #53 | AE response time ms  
    optional DataCenter_PB                  data_center             = 3;                // #56 | Data Center Name
    optional DKHistory_PB                   dk_history              = 4;                // #18 | DK History: 
    optional AlgorithmCode_E                algorithm               = 5;                // #50 | Advert Algorithm
    optional RTBOperationResultCode_E       rtb_code                = 6;                // #54 | RTB explain code
    optional uint32                         bids_accepted           = 7;                // #55-1 | RTB Bids Accepted
    optional uint32                         bids_received           = 8;                // #55-2 | RTB Bids Received
    optional string                         opaque_debug_log        = 9;                // #63 | Debug Black Box            
    optional MarketPricing_PB               market_pricing          = 10;               // #64 | Market Pricing
    optional double                         rtb_premium_applied     = 11;               // #68 | RTB DPF Premium Applied (optional)
    optional PSACode_E                      psa_code                = 12;               // #69 | Status code (PSA code)
    optional string                         pi_debug                = 13;               // #72 | Pricing Intelligence Debug Message
    optional AdCounts_PB                    ad_counts               = 14;               // #73 | All Guaranteed/Bids/Bidded-Ads/Total-Valid Counts
    optional double                         imp_quality_score       = 15;               // #74 | Impression Quality Score
    optional string                         uri_arguments           = 16;               // #76 | URI Arguments in Raw Format
    repeated FeatureCode_E                  features                = 17;               // #79 | Codes for AdEngine features used 
}


//
// transaction specific info in the AE log
//
message TransactionInfo_PB {
    optional rubicon.data.common.AnUInt32_PB            ad_id                  = 1;                 // #36 | Ad ID: unique Ad Identifier 
    optional uint32                                     network_id             = 2 [default = 0];   // #40 | Network ID: 
    optional int32                                      campaign_id            = 3 [default = 0];   // #42 | Campaign ID: int32 to cover negative cases 
    optional string                                     restrict_block_match   = 4;                 // #44 | Restrictions Block Matching: 
    optional string                                     extra_block_match      = 5;                 // #45 | Extra Block Matching: 
    optional uint32                                     creative_id            = 6 [default = 0];   // #46 | Creative ID:    
    optional string                                     auction_id             = 7;                 // #47 | Auction ID: (rtb)    
    optional double                                     revenue_cpm            = 8 [default = 0];   // #48 | Revenue CPM
    optional rubicon.data.common.AdClassType_E          ad_class               = 9;                 // #49 | Ad Class
    optional double                                     rtb_tech_fee_assessed  = 10;                // #51 | RTB Tech fee assessed
    optional uint64                                     rtb_response_time      = 11;                // #52 | RTB response time ms
    optional uint32                                     advertiser_id          = 12;                // #58 | Advertiser Id from RTB Imp
    optional uint32                                     rtb_billable_seat_id   = 13;                // #59 | Billable Seat ID - was agency ID
    optional rubicon.data.common.PrivateTierType_E      private_tier           = 14;                // #60 | Private Marketplace tier code
    optional uint32                                     bid_id                 = 15;                // #61 | RTB Bid Id from RTB Imp
    optional double                                     bid_price              = 16;                // #62 | RTB Bid Price                     
    repeated uint32                                     rtb_seat_ids           = 17;                // #65 | Seat IDs from RTB Imp (comma sep)
    optional double                                     rtb_price_floor        = 18;                // #66 | RTB Price Floor (if win)
    optional double                                     rtb_second_price       = 19;                // #67 | RTB Second Price (if win)
    optional uint32                                     rtb_deal_id            = 20;                // #70 | Deal ID (from applied rtb rule)
    optional uint32                                     second_ad_id           = 21;                // #71 | Second place Ad_id
    optional rubicon.data.adsafe.AdSafeResponse_PB      adsafe                 = 22;                // #75 | AdSafe lookup results
    optional uint32                                     best_rival_ad_id       = 23;                // #77 -1 | Best rival ad_id
    optional double                                     best_rival_cpm_price   = 24;                // #77 -2 | Best rival cpm price
    optional string                                     external_creative_id   = 25;                // #78 | External Creative ID, primarily from RTB bidders.    
}

//
// ad-engine log message
//
message AdEngineLog_PB {
    optional UserInfo_PB            user_info           = 1;
    optional GeoInfo_PB             geo_info            = 2;
    optional InventoryInfo_PB       inventory_info      = 3;
    optional SystemInfo_PB          system_info         = 4;
    optional TransactionInfo_PB     transaction_info    = 5;                     
}
